<html>

<!-- these 4 files always have to be included -->
<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>

<!-- these two file always have to be included -->
<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>

<link rel="stylesheet" type="text/css" href="./tooltip.css"/>

<!-- you have to define 2 functions in the global scope: -->
<script type="text/javascript">

    // Dictionary (systemDictionary is global variable from adapter-settings.js)
    systemDictionary = {
        "page_title":   {"en": "Smartmeter Adapter Settings", "de": "Smartmeter Adapter Einstellungen"},

        "heading_GeneralSettings":   {"en": "General Settings", "de": "Generelle Einstellungen"},
        "heading_TransportSpecificSettings":   {"en": "Data Transfer Settings", "de": "Einstellungen Datenübertragung"},
        "heading_ProtocolSpecificSettings":   {"en": "Data Protocol Settings", "de": "Einstellungen Datenprotokoll"},

        "field_protocol":   {"en": "Data Protocol", "de": "Daten-Protokoll"},
        "value_protocol_D0Protocol":   {"en": "D0 (WakeUp, SignOn, Data)", "de": "D0 (WakeUp, SignOn, Data)"},
        "value_protocol_JsonEfrProtocol":   {"en": "JSON-Format EFR SmartGridHub", "de": "JSON-Format EFR SmartGridHub"},
        "value_protocol_SmlProtocol":   {"en": "SmartMeterLanguage 1.0.3", "de": "SmartMeterLanguage 1.0.3"},
        "info_protocol":   {"en": " ", "de": " "},

        "field_transport":   {"en": "Data Transfer", "de": "Datenübertragung"},
        "value_transport_HttpRequestTransport":   {"en": "Read Data from an HTTP URL", "de": "Daten von einer HTTP-URL auslesen"},
        "value_transport_LocalFileTransport":   {"en": "Read Data from a local file", "de": "Daten aus einer lokalen Datei lesen"},
        "value_transport_SerialRequestResponseTransport":   {"en": "Serial Device with Bi-dir. comm.", "de": "Serielles Gerät mit bidir. Komm."},
        "value_transport_SerialResponseTransport":   {"en": "Serial Device reading data only", "de": "Serielles Gerät Daten werden nur gelesen"},
        "info_transport":   {"en": " ", "de": " "},

        "field_requestInterval":   {"en": "Data request interval", "de": "Daten Abfrageintervall"},
        "info_requestInterval":   {"en": "use 0 for continous reading/requesting,<br>Default if empty: 300", "de": "0 benutzen um ohne Unterbrechung zu lesen/anzufordern,<br>Standard wenn leer: 300"},

        "field_transportSerialPort":   {"en": "Serial Device Name", "de": "Serielles Gerät: Name"},
        "info_transportSerialPort":   {"en": " ", "de": " "},

        "field_transportSerialBaudrate":   {"en": "Serial Device Baudrate", "de": "Serielles gerät: Baudrate"},
        "info_transportSerialBaudrate":   {"en": "If empty, protocol defaults are used<br>(D0: 300, SML: 9600)", "de": "Wenn leer werden Protokoll-Standards verwendet<br>(D0: 300, SML: 9600)"},

        "field_transportHttpRequestUrl":   {"en": "HTTP-URL", "de": "HTTP-URL"},
        "info_transportHttpRequestUrl":   {"en": " ", "de": " "},

        "field_transportHttpRequestTimeout":   {"en": "HTTP-Request Timeout", "de": "HTTP-Amfrage Timeout"},
        "info_transportHttpRequestTimeout":   {"en": "Default if empty: 2000", "de": "Standard wenn leer: 2000"},

        "field_transportLocalFilePath":   {"en": "Absolute path to local datafile", "de": "Absoluter Pfad zur Daten-Datei"},
        "info_transportLocalFilePath":   {"en": " ", "de": " "},

        "field_protocolD0WakeupCharacters":   {"en": "D0: Number of WakeUp-Characters", "de": "D0: Anzahl WakeUp-Character"},
        "info_protocolD0WakeupCharacters":   {"en": "(NULL characters)<br>Default if empty: 0", "de": "(NULL Zeichen) <br>Standard wenn leer: 0"},

        "field_protocolD0DeviceAddress":   {"en": "D0: Device Address", "de": "D0: Geräteadresse"},
        "info_protocolD0DeviceAddress":   {"en": "(Empty by default)", "de": "(leer wenn nicht angegeben)"},

        "field_protocolD0SignOnMessage":   {"en": "D0: SignOn-Message Command", "de": "D0: Kommando SignOn-Nachricht"},
        "info_protocolD0SignOnMessage":   {"en": "(Default if empty: <b>?</b><br>to read mandatory values)", "de": "(Standard wenn leer: <b>?</b><br> um Pflichtwerte zu lesen)"},

        "field_protocolSmlIgnoreInvalidCRC":   {"en": "SML: Ignore CRC checksum error", "de": "SML: CRC-prüfsummenfehler ignorieren"},
        "info_protocolSmlIgnoreInvalidCRC":   {"en": " ", "de": " "},

        "field_obisFallbackMedium":   {"en": "D0: Fallback OBIS-Medium", "de": "D0: Ersatz OBIS-Medium"},
        "value_obisFallbackMedium_0":   {"en": "0: Abstract", "de": "0: Abstrakt"},
        "value_obisFallbackMedium_1":   {"en": "1: Electricity", "de": "1: Strom"},
        "value_obisFallbackMedium_4":   {"en": "4: Heat cost Allocator", "de": "4: Heizkostenverteiler"},
        "value_obisFallbackMedium_5":   {"en": "5: Cooling", "de": "5: Kälte"},
        "value_obisFallbackMedium_6":   {"en": "6: Heat", "de": "6: Wärme"},
        "value_obisFallbackMedium_7":   {"en": "7: Gas", "de": "7: Gas"},
        "value_obisFallbackMedium_8":   {"en": "8: Cold water", "de": "8: Kaltwasser"},
        "value_obisFallbackMedium_9":   {"en": "9: Hot water", "de": "9: Warmwasser"},
        "value_obisFallbackMedium_16":   {"en": "16: Oil", "de": "16: Öl"},
        "value_obisFallbackMedium_17":   {"en": "17: Compressed air", "de": "17: Druckluft"},
        "value_obisFallbackMedium_18":   {"en": "18: Nitrogen", "de": "18: Stickstoff"},
        "info_obisFallbackMedium":   {"en": "(used for name resolving when no OBIS medium is defined in data message)", "de": "(wird zur Namensauflösung benutzt falls kein OBIS-Medium in den Daten existiert)"},

        "field_obisNameLanguage":   {"en": "Language for Datapoint Names", "de": "Sprache der Datenpunktnamen"},
        "value_obisNameLanguage_de":   {"en": "German", "de": "Deutsch"},
        "value_obisNameLanguage_en":   {"en": "English", "de": "Englisch"},
        "info_obisNameLanguage":   {"en": " ", "de": " "},
    };

    var convertComma = null;
    function setValue(id, value, onChange) {
        // example: select elements with id=key and class=value and insert value
        if ($('#' + id + '.value').attr('type') === 'checkbox') {
            $('#' + id + '.value').prop('checked', value).change(function () {
                onChange();
            });
        } else {
            $('#' + id + '.value').val(value).change(function() {
                onChange();
            }).keyup(function() {
                // Check that only numbers entered
                if ($(this).hasClass('number')) {
                    var val = $(this).val();
                    if (val) {
                        var newVal = '';
                        for (var i = 0; i < val.length; i++) {
                            if ((val[i] >= '0' && val[i] <= '9') || val[i] === '-' || val[i] === '+' || val[i] === '.' || val[i] === ',') {
                                if (val[i] === '.' && convertComma === true)  val[i] === ',';
                                if (val[i] === ',' && convertComma === false) val[i] === '.';
                                newVal += val[i];
                            }
                        }

                        if (val != newVal) $(this).val(newVal);
                    }
                }
                $(this).trigger('change');
           });
        }
    }

    function load(settings, onChange) {
        // works only with newest admin adapter
        if (typeof systemConfig !== 'undefined') {
            convertComma = systemConfig.common.isFloatComma;
        }

       for (var key in settings) {
            setValue(key, settings[key], onChange);
        }

        $('#protocol').change(function () {
            if ($(this).val() === 'D0Protocol') {
                $('.D0Protocol').show();
                $('.JsonEfrProtocol').hide();
                $('.SmlProtocol').hide();
            } else if ($(this).val() === 'JsonEfrProtocol') {
                $('.D0Protocol').hide();
                $('.JsonEfrProtocol').show();
                $('.SmlProtocol').hide();
            } else if ($(this).val() === 'SmlProtocol') {
                $('.D0Protocol').hide();
                $('.JsonEfrProtocol').hide();
                $('.SmlProtocol').show();
            }
        }).trigger('change');

        $('#transport').change(function () {
            if ($(this).val() === 'HttpRequestTransport') {
                $('.HttpRequestTransport').show();
                $('.LocalFileTransport').hide();
                $('.SerialTransports').hide();
            } else if ($(this).val() === 'LocalFileTransport') {
                $('.HttpRequestTransport').hide();
                $('.LocalFileTransport').show();
                $('.SerialTransports').hide();
            } else if ($(this).val() === 'SerialRequestResponseTransport') {
                $('.HttpRequestTransport').hide();
                $('.LocalFileTransport').hide();
                $('.SerialTransports').show();
            } else if ($(this).val() === 'SerialResponseTransport') {
                $('.HttpRequestTransport').hide();
                $('.LocalFileTransport').hide();
                $('.SerialTransports').show();
            }
        }).trigger('change');

        onChange(false);
    }

    // ... and the function save has to exist.
    // you have to make sure the callback is called with the settings object as first param!
    function save(callback) {
        // example: select elements with class=value and build settings object
        var settings = {};
        $('.value').each(function () {
            var $this = $(this);
            var id = $this.attr('id');

            if ($this.attr('type') == 'checkbox') {
                settings[id] = $this.prop('checked');
            } else {
                settings[id] = $this.val();
           }
        });

        callback(settings);
    }
</script>

<!-- you have to put your config page in a div with id adapter-container -->
<div id="adapter-container">

    <table><tr>
        <td><img src="smartmeter.png"/></td>
        <td><h3 class="translate">page_title</h3></td>
    </tr></table>
    <table>
        <tr><td colspan="3"><h4 class="translate">heading_GeneralSettings</h4></td></tr>
        <tr>
            <td class="translate">field_requestInterval</td>
            <td><input id="requestInterval" type="text" size="10" class="value number"/> s</td>
            <td>
                <div class="tooltip">
                    <a href="https://github.com/Apollon77/ioBroker.smartmeter/#data-request-interval" target="config_help">
                        <img width="15" height="15" src="./questionmark.png">
                    </a>
                    <span class="tooltiptext translate">info_requestInterval</span>
                </div>
            </td>
        </tr>
        <tr>
            <td class="translate">field_transport</td>
            <td><select id="transport" class="value">
                <option class="translate" value="HttpRequestTransport">value_transport_HttpRequestTransport</option>
                <option class="translate" value="LocalFileTransport">value_transport_LocalFileTransport</option>
                <option class="translate" value="SerialRequestResponseTransport">value_transport_SerialRequestResponseTransport</option>
                <option class="translate" value="SerialResponseTransport">value_transport_SerialResponseTransport</option>
            </select></td>
            <td>
                <div class="tooltip">
                    <a href="https://github.com/Apollon77/ioBroker.smartmeter/#data-transfer" target="config_help">
                        <img width="15" height="15" src="./questionmark.png">
                    </a>
                    <!-- <span class="tooltiptext translate">info_transport</span> -->
                </div>
            </td>
        </tr>
        <tr>
            <td class="translate">field_protocol</td>
            <td><select id="protocol" class="value">
                <option class="translate" value="D0Protocol">value_protocol_D0Protocol</option>
                <option class="translate" value="JsonEfrProtocol">value_protocol_JsonEfrProtocol</option>
                <option class="translate" value="SmlProtocol">value_protocol_SmlProtocol</option>
            </select></td>
            <td>
                <div class="tooltip">
                    <a href="https://github.com/Apollon77/ioBroker.smartmeter/#data-protocol" target="config_help">
                        <img width="15" height="15" src="./questionmark.png">
                    </a>
                    <!-- <span class="tooltiptext translate">info_protocol</span> -->
                </div>
            </td>
        </tr>
        <tr>
            <td class="translate">field_obisNameLanguage</td>
            <td><select id="obisNameLanguage" class="value">
                <option class="translate" value="de">value_obisNameLanguage_de</option>
                <option class="translate" value="en">value_obisNameLanguage_en</option>
            </select></td>
            <td class="translate">info_obisNameLanguage</td>
        </tr>
        <tr><td colspan="3"><h4 class="translate">heading_TransportSpecificSettings</h4></td></tr>
        <tr class="SerialTransports">
            <td class="translate">field_transportSerialPort</td>
            <td><input id="transportSerialPort" type="text" class="value"/></td>
            <td class="translate">info_transportSerialPort</td>
        </tr>
        <tr class="SerialTransports">
            <td class="translate">field_transportSerialBaudrate</td>
            <td><input id="transportSerialBaudrate" type="text" class="value number"/> baud</td>
            <td>
                <div class="tooltip">
                    <a href="https://github.com/Apollon77/ioBroker.smartmeter/#serial-device-baudrate" target="config_help">
                        <img width="15" height="15" src="./questionmark.png">
                    </a>
                    <span class="tooltiptext translate">info_transportSerialBaudrate</span>
                </div>
            </td>
        </tr>
        <tr class="HttpRequestTransport">
            <td class="translate">field_transportHttpRequestUrl</td>
            <td><input id="transportHttpRequestUrl" type="text" class="value"/></td>
            <td class="translate">info_transportHttpRequestUrl</td>
        </tr>
        <tr class="HttpRequestTransport">
            <td class="translate">field_transportHttpRequestTimeout</td>
            <td><input id="transportHttpRequestTimeout" type="text" class="value number"/> ms</td>
            <td>
                <div class="tooltip">
                    <img width="15" height="15" src="./questionmark.png">
                    <span class="tooltiptext translate">info_transportHttpRequestTimeout</span>
                </div>
            </td>
        </tr>
        <tr class="LocalFileTransport">
            <td class="translate">field_transportLocalFilePath</td>
            <td><input id="transportLocalFilePath" type="text" class="value"/></td>
            <td class="translate">info_transportLocalFilePath</td>
        </tr>
        <tr class="D0Protocol"><td colspan="3"><h4 class="translate">heading_ProtocolSpecificSettings</h4></td></tr>
        <tr class="SmlProtocol"><td colspan="3"><h4 class="translate">heading_ProtocolSpecificSettings</h4></td></tr>
        <tr class="D0Protocol">
            <td class="translate">field_protocolD0WakeupCharacters</td>
            <td><input id="protocolD0WakeupCharacters" type="text" class="value"/></td>
            <td>
                <div class="tooltip">
                    <img width="15" height="15" src="./questionmark.png">
                    <span class="tooltiptext translate">info_protocolD0WakeupCharacters</span>
                </div>
            </td>
        </tr>
        <tr class="D0Protocol">
            <td class="translate">field_protocolD0DeviceAddress</td>
            <td><input id="protocolD0DeviceAddress" type="text" size="32" class="value"/></td>
            <td>
                <div class="tooltip">
                    <img width="15" height="15" src="./questionmark.png">
                    <span class="tooltiptext translate">info_protocolD0DeviceAddress</span>
                </div>
            </td>
        </tr>
        <tr class="D0Protocol">
            <td class="translate">field_protocolD0SignOnMessage</td>
            <td><input id="protocolD0SignOnMessage" type="text" class="value"/></td>
            <td>
                <div class="tooltip">
                    <a href="https://github.com/Apollon77/ioBroker.smartmeter/#d0--signon-message-command" target="config_help">
                        <img width="15" height="15" src="./questionmark.png">
                    </a>
                    <span class="tooltiptext translate">info_protocolD0SignOnMessage</span>
                </div>
            </td>
        </tr>
        <tr class="SmlProtocol">
            <td class="translate">field_protocolSmlIgnoreInvalidCRC</td>
            <td><input id="protocolSmlIgnoreInvalidCRC" type="checkbox" class="value"/></td>
            <td class="translate">info_protocolSmlIgnoreInvalidCRC</td>
        </tr>
        <tr class="D0Protocol">
            <td class="translate">field_obisFallbackMedium</td>
            <td><select id="obisFallbackMedium" class="value">
                <option class="translate" value="0">value_obisFallbackMedium_0</option>
                <option class="translate" value="1">value_obisFallbackMedium_1</option>
                <option class="translate" value="4">value_obisFallbackMedium_4</option>
                <option class="translate" value="5">value_obisFallbackMedium_5</option>
                <option class="translate" value="6">value_obisFallbackMedium_6</option>
                <option class="translate" value="7">value_obisFallbackMedium_7</option>
                <option class="translate" value="8">value_obisFallbackMedium_8</option>
                <option class="translate" value="9">value_obisFallbackMedium_9</option>
                <option class="translate" value="16">value_obisFallbackMedium_16</option>
                <option class="translate" value="17">value_obisFallbackMedium_17</option>
                <option class="translate" value="18">value_obisFallbackMedium_18</option>
            </select></td>
            <td>
                <div class="tooltip">
                    <img width="15" height="15" src="./questionmark.png">
                    <span class="tooltiptext translate">info_obisFallbackMedium</span>
                </div>
            </td>
        </tr>
    </table>
</div>

</html>
